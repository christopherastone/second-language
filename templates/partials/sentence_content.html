<div id="sentence-content" class="fade-in">
  <div class="card p-8 mb-8">
    {% if content %}
      <div class="text-xl sm:text-2xl font-semibold leading-loose flex flex-wrap gap-2">
        {% for token in content.tokens -%}
          {% set is_punct = not (token.surface | has_alpha) %}
          <span class="token-card">
            {% if is_punct or token.lemma is not defined %}
              <span class="block">{{ token.surface }}</span>
            {% else %}
              <a
                class="block"
                href="{{ token.lemma | lemma_url(language) }}"
              >{{ token.surface }}</a>
            {% endif %}
            {% if is_punct %}
              <span class="gloss block text-muted text-sm font-normal">&nbsp;</span>
            {% else %}
              <span class="gloss block text-muted text-sm font-normal">
                {% if token.tags %}
                  {{ token.translation }}.{{ token.tags | join('.') }}
                {% else %}
                  {{ token.translation }}
                {% endif %}
              </span>
            {% endif %}
          </span>{% if not loop.last %} {% endif %}
        {%- endfor %}
      </div>

      <div class="mt-8 pt-6 border-t border-[color:var(--border-light)]">
        <p class="section-title mb-2">Natural translation</p>
        <p class="text-lg text-secondary leading-relaxed">
          {{ content.natural_english_translation }}
        </p>
      </div>
    {% else %}
      <div class="text-lg font-semibold">{{ sentence.text }}</div>
    {% endif %}
  </div>

  {% if content and content.proper_nouns %}
    <div class="mb-8">
      <h2 class="section-title mb-4">Proper nouns</h2>
      <div class="space-y-3">
        {% for item in content.proper_nouns %}
          <div class="info-card">
            <p class="info-card-title">{{ item.nominative }}</p>
            <p class="info-card-text">{{ item.definition }}</p>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  {% if content and content.grammar_notes %}
    <div class="mb-8">
      <h2 class="section-title mb-4">Grammar notes</h2>
      <div class="space-y-3">
        {% for item in content.grammar_notes %}
          <div class="info-card">
            <p class="info-card-title">{{ item.title }}</p>
            <p class="info-card-text">{{ item.note }}</p>
          </div>
        {% endfor %}
      </div>
    </div>
  {% endif %}

  <div class="action-bar mt-8">
    {% if error %}
      <div class="w-full mb-4 p-3 bg-[color:var(--danger-light)] text-[color:var(--danger)] rounded-lg text-sm">
        {{ error }}
      </div>
    {% endif %}

    <div class="flex flex-wrap items-center gap-3">
      {% set target_id = "sentence-favorite-" ~ sentence.id %}
      {% set action = url_for('sentence_favorite', lang=language, hash_slug=sentence.hash) %}
      {% include "partials/favorite_star.html" %}

      <form
        method="post"
        action="{{ url_for('sentence_regenerate', lang=language, hash_slug=sentence.hash) }}"
        hx-post="{{ url_for('sentence_regenerate', lang=language, hash_slug=sentence.hash) }}"
        hx-target="#sentence-content"
        hx-swap="outerHTML"
        hx-push-url="false"
        class="flex flex-wrap items-center gap-2"
      >
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <select
          id="sentence-model"
          name="model"
          class="select"
        >
          {% for model in model_choices %}
            <option value="{{ model }}" {% if model == selected_model %}selected{% endif %}>{{ model }}</option>
          {% endfor %}
        </select>
        <button
          type="submit"
          class="btn btn-secondary"
          hx-on:htmx:beforeRequest="this.dataset.label=this.innerText; this.innerText='Regenerating...'; this.disabled=true; this.setAttribute('aria-busy','true');"
          hx-on:htmx:afterRequest="this.disabled=false; this.innerText=this.dataset.label || 'Regenerate'; this.removeAttribute('aria-busy');"
        >
          {{ "Try again" if error else "Regenerate" }}
        </button>
      </form>

      <span class="text-xs text-muted">
        Generated with {{ content.model_used if content else 'unknown' }}
      </span>

      <form method="post" action="{{ url_for('sentence_delete', lang=language, hash_slug=sentence.hash) }}" class="ml-auto">
        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
      </form>
    </div>
  </div>
</div>
