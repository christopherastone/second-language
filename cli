#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = [
#   "flask>=3.0.0",
#   "flask-wtf>=1.2.1",
#   "requests>=2.32.0",
#   "feedparser>=6.0.11",
#   "openai>=1.40.0",
#   "pyyaml>=6.0.1",
#   "jsonschema>=4.22.0",
#   "google-cloud-texttospeech>=2.14.0",
#   "python-dotenv>=1.0.1",
# ]
# ///

import argparse
import secrets

from werkzeug.security import generate_password_hash

from config import (
    DEFAULT_MODEL,
    LANGUAGE_RE,
    is_language_valid,
    load_feeds,
)
from db import connect_db, insert_sentence_from_payload, utc_now
from llm import LLMOutputError, LLMRequestError, generate_sentence_content
from normalization import hash_sentence, normalize_text


def ensure_language(lang: str, feeds: list[dict]) -> str:
    language = lang.strip().lower()
    if not LANGUAGE_RE.match(language):
        raise SystemExit("Language must be a two-letter code (e.g., sl)")
    if not is_language_valid(language, feeds):
        raise SystemExit("Language is not configured in feeds.yaml")
    return language


def set_password(args, feeds):
    password_hash = generate_password_hash(args.password)
    db = connect_db()
    try:
        row = db.execute("SELECT default_language FROM settings WHERE id = 1").fetchone()
        if row:
            db.execute(
                "UPDATE settings SET password_hash = ? WHERE id = 1",
                (password_hash,),
            )
        else:
            default_language = feeds[0]["language"] if feeds else ""
            if not default_language:
                raise SystemExit("No languages available in feeds.yaml")
            db.execute(
                "INSERT INTO settings (id, password_hash, default_language) VALUES (1, ?, ?)",
                (password_hash, default_language),
            )
        db.commit()
    finally:
        db.close()


def set_language(args, feeds):
    language = ensure_language(args.language, feeds)
    db = connect_db()
    try:
        row = db.execute("SELECT password_hash FROM settings WHERE id = 1").fetchone()
        if row:
            db.execute(
                "UPDATE settings SET default_language = ? WHERE id = 1",
                (language,),
            )
        else:
            placeholder_password = generate_password_hash(secrets.token_urlsafe(32))
            db.execute(
                "INSERT INTO settings (id, password_hash, default_language) VALUES (1, ?, ?)",
                (placeholder_password, language),
            )
        db.commit()
    finally:
        db.close()


def add_sentence(args, feeds):
    language = ensure_language(args.language, feeds)
    text = normalize_text(args.text)
    if not text:
        raise SystemExit("Sentence text is empty after normalization")
    sentence_hash = hash_sentence(text)

    db = connect_db()
    try:
        existing = db.execute(
            "SELECT id FROM sentences WHERE language = ? AND hash = ?",
            (language, sentence_hash),
        ).fetchone()
        if existing:
            raise SystemExit("Sentence already exists")
        try:
            payload = generate_sentence_content(language, text, DEFAULT_MODEL)
        except (LLMRequestError, LLMOutputError) as exc:
            raise SystemExit(f"LLM generation failed: {exc}") from exc
        created_at = utc_now()
        insert_sentence_from_payload(
            db,
            language=language,
            sentence_hash=sentence_hash,
            text=text,
            article_link=None,
            source_context=None,
            payload=payload,
            created_at=created_at,
        )
        db.commit()
    finally:
        db.close()


def build_parser():
    parser = argparse.ArgumentParser(description="Second Language admin CLI")
    subparsers = parser.add_subparsers(dest="command", required=True)

    password_parser = subparsers.add_parser("set-password", help="Set login password")
    password_parser.add_argument("password")

    language_parser = subparsers.add_parser("set-language", help="Set default language")
    language_parser.add_argument("language")

    sentence_parser = subparsers.add_parser("sentences", help="Sentence management")
    sentence_sub = sentence_parser.add_subparsers(dest="sentence_command", required=True)
    add_parser = sentence_sub.add_parser("add", help="Add a sentence")
    add_parser.add_argument("--text", required=True)
    add_parser.add_argument("--language", required=True)

    return parser


def main():
    feeds = load_feeds()
    parser = build_parser()
    args = parser.parse_args()
    if args.command == "set-password":
        set_password(args, feeds)
    elif args.command == "set-language":
        set_language(args, feeds)
    elif args.command == "sentences":
        if args.sentence_command == "add":
            add_sentence(args, feeds)
    else:
        parser.print_help()


if __name__ == "__main__":
    main()
