# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

"Second Language" - A local web application for learning foreign languages (initially Slovenian) aimed at American English speakers. The app teaches vocabulary and grammar in context by presenting glossed sentences and lemma pages. Content is generated by an LLM on demand and cached in SQLite.

## Technology Stack

- **Back-end**: Flask (Python)
- **Front-end**: HTML, Tailwind CSS (standalone CLI), HTMX
- **Database**: SQLite
- **Package management**: `uv` with `pyproject.toml`
- **Forms/CSRF**: Flask-WTF (CSRFProtect)
- **RSS**: `requests` + `feedparser`
- **LLM**: OpenAI API (default model: `gpt-4o`)

## Commands

```bash
# Install dependencies
uv sync

# Build Tailwind CSS
tailwindcss -i input.css -o static/output.css

# Initialize database
uv run python init_db.py

# CLI for settings and sentence management
uv run python cli set-password <password>
uv run python cli set-language <lang>
uv run python cli sentences add --text <text> --language <lang>

# Run development server
uv run flask run

# Run with gunicorn (production)
uv run gunicorn app:app
```

## Environment Variables

Required (app fails to start if missing):

| Variable | Purpose |
|----------|---------|
| `SECRET_KEY` | Flask session signing key |
| `DATABASE_PATH` | Not used (path is hard-coded to `./data/app.db`) |
| `OPENAI_API_KEY` | OpenAI API key (validated via /models endpoint on startup) |

## Architecture

### URL Structure

- `/login` - Password-only login page
- `/` - Redirects to configured default language
- `/<lang>/` - Sentence list for language (404 if no feed entries)
- `/<lang>/sentence/<hash_slug>` - Sentence detail (hash_slug = first 16 hex chars of SHA-256)
- `/<lang>/lemma/<normalized_lemma>` - Lemma detail (URL-encoded)
- `/favorites` - Favorited sentences and lemmas

### Data Flow

**Sentences (eager generation):**
1. RSS headlines fetched via "Update" button on sentence list page
2. Headlines processed: decode HTML entities, strip editorial markers `[VIDEO]`, normalize
3. LLM generates content (translations/grammar/proper nouns) immediately
4. Only sentences with successful LLM generation are inserted into database
5. Failed generations are skipped (not added to database or dedup table)

**Lemmas (lazy generation):**
1. Lemma records created when user visits the lemma page
2. LLM generates content inline with loading state
3. Cached in database for subsequent visits

### Key Concepts

- **Normalization**: Unicode NFKC, collapsed whitespace, trimmed. Applied to all sentences and lemmas before storage/lookup.
- **Tokenization**: Produced by LLM (not local tokenizer). Multi-word proper nouns are single tokens.
- **Gloss format**: `translation.tag1.tag2` (Leipzig abbreviations, dot-separated, e.g., `to run.3.sg`)
- **Schema versioning**: `schema_version` stored in database column only (not in JSON). Mismatches trigger regeneration.
- **Access counting**: Full page loads (not HTMX partials) increment counters. Omit `(0)` on sentence list.
- **Favorites**: Global (single-user app), star icon toggle, unified favorites page. Cascade deleted when sentence/lemma deleted.
- **Language validity**: Any feed entry (enabled or disabled) makes a language code valid.

### Database Tables

- `settings` - password_hash, default_language (single row, id=1)
- `sentences` - language, hash (16 chars), text, gloss_json, proper_nouns_json, grammar_notes_json, model_used, schema_version, access_count
- `lemmas` - language, normalized_lemma, translation, related_words_json, model_used, schema_version, access_count
- `rss_articles` - feed_id, article_id (deduplication, kept on sentence delete)
- `favorites` - item_type, item_id, created_at

### LLM Integration

- Models: `gpt-5-nano`, `gpt-5-mini`, `gpt-5`, `gpt-4.1`, `gpt-4o` (default; all shown in selector)
- Startup: Call `/models` endpoint (free) to validate key, exit if invalid
- Timeout: 60 seconds
- Retries: up to 2 on transient errors (429, 5xx)
- Invalid JSON: one retry, then show error with model selector + "Try again" button
- Session remembers last selected model
- No regeneration cooldown

### HTMX Behavior

- Page navigations push browser history (`hx-push-url="true"`)
- No history push for: Regenerate, Favorite toggle, Update button, Delete
- Native browser loading indicators only (no custom spinners)

### Security

- All state-changing forms require CSRF token
- HTMX state changes require `X-CSRFToken` header
- Passwords hashed with PBKDF2-SHA256 (Werkzeug)
- Session cookies: HttpOnly, SameSite=Lax, Secure (if HTTPS)
- Login rate limiting: in-memory (resets on restart), 5s initial, 2x backoff, 60s cap, decays after 1 hour
- All routes except `/login` require authentication
- No logout button (sessions persist until browser clears cookies)

### UI Guidelines

- App name: "Second Language"
- Single light theme (no dark mode)
- Header shows: logo, language switcher (if multiple languages), favorites link
- Footer shows app version (from pyproject.toml)
- Token clicks: show underline on hover (standard link behavior)
- Gloss text: same size as token, muted color
- Delete buttons: immediate action, no confirmation, cascade deletes favorites
- Sentence deletion: keeps article_id in rss_articles, lemmas remain (orphan growth accepted)

## Configuration Files

- `feeds.yaml` - RSS feed definitions with id, url, language, enabled fields
  - Manual editing only (no CLI)
  - Missing/malformed file causes startup failure
  - Language valid if any feed entry exists (enabled or not)
