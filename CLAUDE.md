# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

"Second Language" - A local web application for learning foreign languages (initially Slovenian) aimed at American English speakers. The app teaches vocabulary and grammar in context by presenting glossed sentences and lemma pages. Content is generated by an LLM on demand and cached in SQLite.

## Technology Stack

- **Back-end**: Flask (Python)
- **Front-end**: HTML, Tailwind CSS (standalone CLI), HTMX
- **Database**: SQLite
- **Package management**: `uv` with `pyproject.toml`
- **Forms/CSRF**: Flask-WTF (CSRFProtect)
- **RSS**: `requests` + `feedparser`
- **LLM**: OpenAI API (default model: `gpt-5-nano`)

## Commands

```bash
# Install dependencies
uv sync

# Build Tailwind CSS
./tailwindcss -i input.css -o static/output.css

# Initialize database
uv run python init_db.py

# Unified CLI for user and sentence management
uv run python cli users list
uv run python cli users create --username <user> --password <pass> --default-language <lang>
uv run python cli users update --username <user> [--password <pass>] [--default-language <lang>]
uv run python cli users delete --username <user>
uv run python cli sentences add --text <text> --language <lang>

# Run development server
uv run flask run

# Run with gunicorn (production)
uv run gunicorn app:app
```

## Environment Variables

All required (app fails to start if missing):

| Variable | Purpose |
|----------|---------|
| `SECRET_KEY` | Flask session signing key |
| `DATABASE_PATH` | Path to SQLite database file (no default) |
| `OPENAI_API_KEY` | OpenAI API key (validated on startup) |

## Architecture

### URL Structure

- `/login` - Login page
- `/` - Redirects to user's default language
- `/<lang>/` - Sentence list for language (404 if no feeds configured)
- `/<lang>/sentence/<hash_slug>` - Sentence detail (hash_slug = first 10 hex chars of SHA-256)
- `/<lang>/lemma/<normalized_lemma>` - Lemma detail (URL-encoded)
- `/favorites` - User's favorited sentences and lemmas

### Data Flow

1. RSS headlines fetched via "Update" button on sentence list page
2. Headlines processed: decode HTML entities, strip editorial markers `[VIDEO]`, normalize
3. Headlines stored in `sentences` table (no content yet)
4. On first sentence detail access, LLM generates gloss/grammar/proper nouns
5. LLM output validated against JSON schema, cached in database
6. Subsequent visits serve cached content instantly
7. Schema version mismatches trigger lazy regeneration on next access

### Key Concepts

- **Normalization**: Unicode NFKC, collapsed whitespace, trimmed. Applied to all sentences and lemmas before storage/lookup.
- **Tokenization**: Produced by LLM (not local tokenizer). Multi-word proper nouns are single tokens. Loanwords marked with `is_loanword: true`.
- **Gloss format**: `translation.tag1.tag2` (Leipzig abbreviations, dot-separated, e.g., `to run.3.sg`)
- **Schema versioning**: Cached content has `schema_version`; mismatches trigger lazy regeneration.
- **Access counting**: Full page loads (not HTMX partials) increment counters. Omit `(0)` on sentence list.
- **Favorites**: Per-user (not shared), star icon toggle, unified favorites page.

### Database Tables

- `users` - username, password_hash, default_language
- `sentences` - language, hash, text, gloss_json, proper_nouns_json, grammar_notes_json, model_used, schema_version, access_count
- `lemmas` - language, normalized_lemma, translation, related_words_json, model_used, schema_version, access_count
- `rss_articles` - feed_id, article_id (deduplication, kept on sentence delete)
- `favorites` - username, item_type, item_id, created_at

### LLM Integration

- Models: `gpt-5-nano` (default), `gpt-5-mini`, `gpt-5` (all shown in selector)
- Startup: Test API call to validate key, exit if invalid
- Timeout: 60 seconds
- Retries: up to 2 on transient errors (429, 5xx)
- Invalid JSON: one retry, then show error with model selector + "Try again" button
- Session remembers last selected model
- No regeneration cooldown

### HTMX Behavior

- Page navigations push browser history (`hx-push-url="true"`)
- No history push for: Regenerate, Favorite toggle, Update button, Delete
- Native browser loading indicators only (no custom spinners)

### Security

- All state-changing forms require CSRF token
- HTMX state changes require `X-CSRFToken` header
- Passwords hashed with PBKDF2-SHA256 (Werkzeug)
- Session cookies: HttpOnly, SameSite=Lax, Secure (if HTTPS)
- Login rate limiting: 5s initial delay, 2x backoff, 60s cap, decays after 1 hour
- All routes except `/login` require authentication
- No logout button (sessions persist until browser clears cookies)

### UI Guidelines

- App name: "Second Language"
- Single light theme (no dark mode)
- Header shows: logo, language switcher (if multiple languages), favorites link
- No username display
- Footer shows app version (from pyproject.toml)
- Token clicks navigate directly (no preview, no visual click indication)
- Gloss text: same size as token, muted color
- Delete buttons: immediate action, no confirmation
- Sentence deletion: keeps article_id in rss_articles, lemmas remain

## Configuration Files

- `feeds.yaml` - RSS feed definitions with id, url, language, enabled fields (manual editing only)
